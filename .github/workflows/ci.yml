name: TeleCrypt Overlay CI

on:
  push:
    branches: [ "**" ]
  pull_request:
  workflow_dispatch:

env:
  ANDROID_RELEASE_STORE_FILE_BASE64: ${{ secrets.ANDROID_RELEASE_STORE_FILE_BASE64 || '' }}
  ANDROID_RELEASE_STORE_PASSWORD: ${{ secrets.ANDROID_RELEASE_STORE_PASSWORD || '' }}
  ANDROID_RELEASE_KEY_ALIAS: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS || '' }}
  ANDROID_RELEASE_KEY_PASSWORD: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD || '' }}
  ANDROID_SERVICE_ACCOUNT_JSON_BASE64: ${{ secrets.ANDROID_SERVICE_ACCOUNT_JSON_BASE64 || '' }}
  APPLE_KEYCHAIN_FILE_BASE64: ${{ secrets.APPLE_KEYCHAIN_FILE_BASE64 || '' }}
  APPLE_KEYCHAIN_PASSWORD: ${{ secrets.APPLE_KEYCHAIN_PASSWORD || '' }}
  APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID || '' }}
  APPLE_ID: ${{ secrets.APPLE_ID || '' }}
  APPLE_NOTARIZATION_PASSWORD: ${{ secrets.APPLE_NOTARIZATION_PASSWORD || '' }}
  WINDOWS_CODE_SIGNING_THUMBPRINT: ${{ secrets.WINDOWS_CODE_SIGNING_THUMBPRINT || '' }}
  WINDOWS_CODE_SIGNING_TIMESTAMP_SERVER: ${{ secrets.WINDOWS_CODE_SIGNING_TIMESTAMP_SERVER || '' }}
  WINDOWS_CERT_FILE_BASE64: ${{ secrets.WINDOWS_CERT_FILE_BASE64 || '' }}
  WINDOWS_CERT_PASSWORD: ${{ secrets.WINDOWS_CERT_PASSWORD || '' }}
  IOS_MOBILEPROVISION_BASE64: ${{ secrets.IOS_MOBILEPROVISION_BASE64 || '' }}
  ENABLE_IOS_BUILD: ${{ secrets.ENABLE_IOS_BUILD || 'false' }}
  UPLOAD_TO_STORES: ${{ secrets.UPLOAD_TO_STORES || 'false' }}
  WORKSPACE: overlay/workspace/layers/telecrypt-app

jobs:
  setup:
    name: Resolve build flags
    runs-on: ubuntu-latest
    steps:
      - name: Echo configuration summary
        run: |
          echo "ENABLE_IOS_BUILD=${ENABLE_IOS_BUILD}"
          echo "UPLOAD_TO_STORES=${UPLOAD_TO_STORES}"

  android:
    name: Android Release Build
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap overlay
        run: ./overlay/bootstrap.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Configure Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: tools platform-tools platforms;android-35 build-tools;35.0.0

      - name: Prepare signing keystore
        if: env.ANDROID_RELEASE_STORE_FILE_BASE64 != ''
        working-directory: ${{ env.WORKSPACE }}
        run: |
          echo "$ANDROID_RELEASE_STORE_FILE_BASE64" | base64 --decode > android_keystore.jks

      - name: Android build
        run: ./overlay/build.sh bundleRelease assembleRelease

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-artifacts
          path: |
            ${{ env.WORKSPACE }}/build/outputs/apk/release/*.apk
            ${{ env.WORKSPACE }}/build/outputs/bundle/release/*.aab

      - name: Setup Ruby (Fastlane)
        if: env.UPLOAD_TO_STORES == 'true'
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Bundle install (Fastlane)
        if: env.UPLOAD_TO_STORES == 'true'
        working-directory: ${{ env.WORKSPACE }}
        run: bundle install

      - name: Fastlane Android internal (optional upload)
        if: env.UPLOAD_TO_STORES == 'true'
        working-directory: ${{ env.WORKSPACE }}
        run: bundle exec fastlane android internal

  desktop_linux:
    name: Desktop & Web (Linux)
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap overlay
        run: ./overlay/bootstrap.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y flatpak zip

      - name: Linux desktop/web build
        run: ./overlay/build.sh createReleaseDistributable packageReleasePlatformZip packageReleaseWebZip

      - name: Upload Linux desktop artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-linux-artifacts
          path: ${{ env.WORKSPACE }}/build/compose/binaries/main-release/**

      - name: Upload web artifacts
        uses: actions/upload-artifact@v4
        with:
          name: web-artifacts
          path: ${{ env.WORKSPACE }}/build/compose/binaries/main-release/zip/*.zip

  desktop_windows:
    name: Desktop (Windows)
    runs-on: windows-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap overlay
        shell: bash
        run: ./overlay/bootstrap.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: Windows desktop build
        shell: bash
        run: ./overlay/build.sh createReleaseDistributable packageReleasePlatformZip packageReleaseMsix

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-windows-artifacts
          path: ${{ env.WORKSPACE }}/build/compose/binaries/main-release/**

  desktop_macos:
    name: Desktop (macOS)
    runs-on: macos-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap overlay
        run: ./overlay/bootstrap.sh

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      - name: macOS desktop build
        run: ./overlay/build.sh createReleaseDistributable packageReleasePlatformZip packageReleaseDmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: desktop-macos-artifacts
          path: ${{ env.WORKSPACE }}/build/compose/binaries/main-release/**

  ios:
    name: iOS Archive
    runs-on: macos-latest
    needs: setup
    if: ${{ env.ENABLE_IOS_BUILD == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Bootstrap overlay
        run: ./overlay/bootstrap.sh

      - name: Setup Ruby (Fastlane)
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'

      - name: Bundle install (Fastlane)
        working-directory: ${{ env.WORKSPACE }}
        run: bundle install

      - name: Apply branding
        working-directory: ${{ env.WORKSPACE }}
        run: ../../../../tools/brandify.sh ../../../../branding/branding.json

      - name: Fastlane iOS build
        env:
          CI_SKIP_GRADLE_EMBED: "true"
        working-directory: ${{ env.WORKSPACE }}
        run: bundle exec fastlane ios build

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-artifacts
          path: |
            ${{ env.WORKSPACE }}/build/TeleCrypt.xcarchive
            ${{ env.WORKSPACE }}/build/*.ipa
